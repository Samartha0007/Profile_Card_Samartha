<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mywebsam - Profile Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>
<body>
    <!-- Login Section -->
    <div id="loginContainer">
        <h2>Welcome to MyWebSam</h2>
        <p>Sign in with Google to manage your profile</p>
        <button id="googleLoginBtn">
            <i class="fab fa-google"></i>
            Continue with Google
        </button>
    </div>

    <!-- Profile Management Section -->
    <div id="profileContainer" style="display: none;">
        <!-- User Info Header -->
        <div id="userInfo">
            <img id="userAvatar" src="" alt="User" width="50" height="50">
            <div>
                <h3 id="userName"></h3>
                <p id="userEmail"></p>
            </div>
            <button id="logoutBtn">Logout</button>
        </div>

        <!-- Profile Status -->
        <div id="profileStatus">
            <p id="statusMessage"></p>
        </div>

        <!-- Form Header -->
        <div>
            <h2 id="formTitle">Create Your Profile</h2>
            <p id="formSubtitle">Share your profile card with the world</p>
        </div>

        <!-- Profile Form -->
        <form id="profileForm">
            <div>
                <label for="name">Name</label>
                <input type="text" id="name" required>
            </div>

            <div>
                <label for="location">Location (City, Country)</label>
                <input type="text" id="location" required>
            </div>

            <div>
                <label for="birthday">Birthday</label>
                <input type="date" id="birthday" required>
            </div>

            <div>
                <label for="profileImage">Profile Picture</label>
                <input type="file" id="profileImage" accept="image/*">
                <div id="imagePreview" style="display: none;">
                    <img id="previewImg" src="" alt="Preview" width="100" height="100">
                </div>
                <p id="fileName"></p>
            </div>

            <div>
                <label for="bio">Bio</label>
                <textarea id="bio" rows="4" required></textarea>
            </div>

            <!-- Social Media Inputs -->
            <fieldset>
                <legend>Social Profiles (Optional)</legend>
                
                <div>
                    <label for="instagram">Instagram</label>
                    <input type="text" id="instagram" placeholder="Instagram username">
                </div>

                <div>
                    <label for="snapchat">Snapchat</label>
                    <input type="text" id="snapchat" placeholder="Snapchat username">
                </div>

                <div>
                    <label for="whatsapp">WhatsApp</label>
                    <input type="text" id="whatsapp" placeholder="WhatsApp number">
                </div>

                <div>
                    <label for="facebook">Facebook</label>
                    <input type="text" id="facebook" placeholder="Facebook username">
                </div>

                <div>
                    <label for="twitter">Twitter</label>
                    <input type="text" id="twitter" placeholder="Twitter username">
                </div>

                <div>
                    <label for="linkedin">LinkedIn</label>
                    <input type="text" id="linkedin" placeholder="LinkedIn username">
                </div>

                <div>
                    <label for="youtube">YouTube</label>
                    <input type="text" id="youtube" placeholder="YouTube channel">
                </div>

                <div>
                    <label for="email">Email</label>
                    <input type="email" id="email" placeholder="Email address">
                </div>

                <div>
                    <label for="telegram">Telegram</label>
                    <input type="text" id="telegram" placeholder="Telegram username">
                </div>

                <div>
                    <label for="github">GitHub</label>
                    <input type="text" id="github" placeholder="GitHub username">
                </div>

                <div>
                    <label for="spotify">Spotify</label>
                    <input type="url" id="spotify" placeholder="Spotify song/playlist link">
                </div>
            </fieldset>

            <!-- Action Buttons -->
            <div>
                <button type="submit" id="saveProfileBtn">Create Profile</button>
                <button type="button" id="viewProfileBtn" style="display: none;">View Profile</button>
                <button type="button" id="deleteProfileBtn" style="display: none;">Delete Profile</button>
            </div>
        </form>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" style="display: none;">
        <div>
            <h3 id="loadingTitle">Creating Your Profile...</h3>
            <div id="loader">Loading...</div>
            <p id="loadingMessage">Please wait while we process your request...</p>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" style="display: none;">
        <div>
            <h3 id="successTitle">Profile Created Successfully!</h3>
            <p id="successMessage">Your profile is now live and ready to share ðŸŽ‰</p>
            <div>
                <p id="profileUrl"></p>
                <button id="copyIcon">Copy Link</button>
            </div>
            <button id="openProfileBtn">View Your Profile</button>
            <button id="closeSuccessBtn">Close</button>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" style="display: none;">
        <div>
            <h3>Delete Profile?</h3>
            <p>Are you sure you want to delete your profile? This action cannot be undone.</p>
            <button id="confirmDeleteBtn">Yes, Delete</button>
            <button id="cancelDeleteBtn">Cancel</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toastNotification" style="display: none;"></div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBb3x_zD9JaFwL9PhmngCNZlS2fOh6MBa4",
            authDomain: "newai-52371.firebaseapp.com",
            projectId: "newai-52371",
            storageBucket: "newai-52371.appspot.com",
            messagingSenderId: "480586908639",
            appId: "1:480586908639:web:f4645a852c4df724c6fa6a"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM Elements
        const loginContainer = document.getElementById("loginContainer");
        const profileContainer = document.getElementById("profileContainer");
        const googleLoginBtn = document.getElementById("googleLoginBtn");
        const logoutBtn = document.getElementById("logoutBtn");
        const userAvatar = document.getElementById("userAvatar");
        const userName = document.getElementById("userName");
        const userEmail = document.getElementById("userEmail");
        const profileStatus = document.getElementById("profileStatus");
        const statusMessage = document.getElementById("statusMessage");
        const formTitle = document.getElementById("formTitle");
        const formSubtitle = document.getElementById("formSubtitle");
        const profileForm = document.getElementById("profileForm");
        const saveProfileBtn = document.getElementById("saveProfileBtn");
        const viewProfileBtn = document.getElementById("viewProfileBtn");
        const deleteProfileBtn = document.getElementById("deleteProfileBtn");

        // Modal Elements
        const loadingModal = document.getElementById("loadingModal");
        const loadingTitle = document.getElementById("loadingTitle");
        const loadingMessage = document.getElementById("loadingMessage");
        const successModal = document.getElementById("successModal");
        const successTitle = document.getElementById("successTitle");
        const successMessage = document.getElementById("successMessage");
        const deleteModal = document.getElementById("deleteModal");
        const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
        const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");
        const profileUrl = document.getElementById("profileUrl");
        const copyIcon = document.getElementById("copyIcon");
        const openProfileBtn = document.getElementById("openProfileBtn");
        const closeSuccessBtn = document.getElementById("closeSuccessBtn");
        const toastNotification = document.getElementById("toastNotification");

        // Form Input Elements
        const nameInput = document.getElementById("name");
        const locationInput = document.getElementById("location");
        const birthdayInput = document.getElementById("birthday");
        const bioInput = document.getElementById("bio");
        const profileImageInput = document.getElementById("profileImage");
        const imagePreview = document.getElementById("imagePreview");
        const previewImg = document.getElementById("previewImg");
        const fileName = document.getElementById("fileName");

        // Social Media Inputs
        const socialInputs = {
            instagram: document.getElementById("instagram"),
            snapchat: document.getElementById("snapchat"),
            whatsapp: document.getElementById("whatsapp"),
            facebook: document.getElementById("facebook"),
            twitter: document.getElementById("twitter"),
            linkedin: document.getElementById("linkedin"),
            youtube: document.getElementById("youtube"),
            email: document.getElementById("email"),
            telegram: document.getElementById("telegram"),
            github: document.getElementById("github"),
            spotify: document.getElementById("spotify")
        };

        // Global Variables
        let currentUser = null;
        let userProfile = null;

        // Event Listeners
        googleLoginBtn.addEventListener("click", signInWithGoogle);
        logoutBtn.addEventListener("click", signOut);
        profileForm.addEventListener("submit", handleFormSubmit);
        viewProfileBtn.addEventListener("click", viewProfile);
        deleteProfileBtn.addEventListener("click", showDeleteModal);
        confirmDeleteBtn.addEventListener("click", deleteProfile);
        cancelDeleteBtn.addEventListener("click", hideDeleteModal);
        closeSuccessBtn.addEventListener("click", hideSuccessModal);
        copyIcon.addEventListener("click", copyProfileLink);
        openProfileBtn.addEventListener("click", openProfile);
        profileImageInput.addEventListener("change", handleImagePreview);

        // Google Sign-In
        async function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                await auth.signInWithPopup(provider);
            } catch (error) {
                console.error("Login error:", error);
                showToast("Login failed. Please try again.");
            }
        }

        // Sign Out
        async function signOut() {
            try {
                await auth.signOut();
            } catch (error) {
                console.error("Logout error:", error);
                showToast("Logout failed. Please try again.");
            }
        }

        // Auth State Observer
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                showProfileContainer();
                updateUserInfo(user);
                await checkExistingProfile();
            } else {
                currentUser = null;
                userProfile = null;
                showLoginContainer();
                resetForm();
            }
        });

        // Show/Hide Containers
        function showLoginContainer() {
            loginContainer.style.display = "block";
            profileContainer.style.display = "none";
        }

        function showProfileContainer() {
            loginContainer.style.display = "none";
            profileContainer.style.display = "block";
        }

        // Update User Info Display
        function updateUserInfo(user) {
            userAvatar.src = user.photoURL || '';
            userName.textContent = user.displayName || 'User';
            userEmail.textContent = user.email;
        }

        // Check for Existing Profile
        async function checkExistingProfile() {
            try {
                const profileDoc = await db.collection("profiles").doc(currentUser.uid).get();
                
                if (profileDoc.exists) {
                    userProfile = profileDoc.data();
                    showExistingProfileMode();
                    populateForm(userProfile);
                } else {
                    showNewProfileMode();
                }
            } catch (error) {
                console.error("Error checking profile:", error);
                showToast("Error loading profile data");
            }
        }

        // Show Existing Profile Mode
        function showExistingProfileMode() {
            statusMessage.textContent = "âœ… You have an existing profile. You can edit it below or view it live.";
            profileStatus.style.backgroundColor = "#d4edda";
            profileStatus.style.color = "#155724";
            
            formTitle.textContent = "Edit Your Profile";
            formSubtitle.textContent = "Update your information anytime";
            saveProfileBtn.textContent = "Update Profile";
            
            viewProfileBtn.style.display = "inline-block";
            deleteProfileBtn.style.display = "inline-block";
        }

        // Show New Profile Mode
        function showNewProfileMode() {
            statusMessage.textContent = "ðŸ‘‹ Welcome! Create your first profile to get started.";
            profileStatus.style.backgroundColor = "#fff3cd";
            profileStatus.style.color = "#856404";
            
            formTitle.textContent = "Create Your Profile";
            formSubtitle.textContent = "Share your profile card with the world";
            saveProfileBtn.textContent = "Create Profile";
            
            viewProfileBtn.style.display = "none";
            deleteProfileBtn.style.display = "none";
        }

        // Populate Form with Existing Data
        function populateForm(profile) {
            nameInput.value = profile.name || '';
            locationInput.value = profile.location || '';
            birthdayInput.value = profile.birthday || '';
            bioInput.value = profile.bio || '';

            // Populate social inputs
            Object.keys(socialInputs).forEach(key => {
                if (socialInputs[key] && profile[key]) {
                    socialInputs[key].value = profile[key];
                }
            });

            // Handle image preview
            if (profile.imageUrl) {
                previewImg.src = profile.imageUrl;
                imagePreview.style.display = "block";
                fileName.textContent = "Current profile picture";
            }
        }

        // Reset Form
        function resetForm() {
            profileForm.reset();
            imagePreview.style.display = "none";
            fileName.textContent = "";
        }

        // Handle Image Preview
        function handleImagePreview(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    previewImg.src = event.target.result;
                    imagePreview.style.display = "block";
                    fileName.textContent = file.name;
                }
                reader.readAsDataURL(file);
            }
        }

        // Upload Image to Cloudinary
        async function uploadImage(file) {
            const cloudName = "dw1qrki2c";
            const uploadPreset = "profile_uploads";

            const formData = new FormData();
            formData.append("file", file);
            formData.append("upload_preset", uploadPreset);

            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
                    method: "POST",
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Image upload failed');
                }

                const data = await response.json();
                return data.secure_url;
            } catch (error) {
                console.error("Error uploading image:", error);
                showToast("Image upload failed. Please try again.");
                throw error;
            }
        }

        // Generate Unique Username
        async function generateUniqueUsername(name) {
            let username = name.toLowerCase().replace(/\s+/g, '').replace(/[^a-z0-9]/g, '');
            if (username.length < 3) username += Math.floor(Math.random() * 1000);

            let count = 1;
            let finalUsername = username;

            try {
                const q = db.collection("profiles").where("username", "==", finalUsername);
                let querySnapshot = await q.get();

                while (!querySnapshot.empty) {
                    finalUsername = username + count;
                    count++;
                    querySnapshot = await db.collection("profiles").where("username", "==", finalUsername).get();
                }

                return finalUsername;
            } catch (error) {
                console.error("Error generating username:", error);
                return username + Math.floor(Math.random() * 10000);
            }
        }

        // Handle Form Submit
        async function handleFormSubmit(e) {
            e.preventDefault();

            const name = nameInput.value.trim();
            const location = locationInput.value.trim();
            const birthday = birthdayInput.value;
            const bio = bioInput.value.trim();
            const imageFile = profileImageInput.files[0];

            // Validation
            if (!name || !location || !birthday || !bio) {
                showToast("Please fill in all required fields");
                return;
            }

            // Age validation
            const birthDate = new Date(birthday);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();

            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }

            if (age < 13) {
                showToast("You must be at least 13 years old to create a profile");
                return;
            }

            // Check if image is required for new profiles
            if (!userProfile && !imageFile) {
                showToast("Please upload a profile picture");
                return;
            }

            // Show loading
            showLoadingModal(userProfile ? "Updating Your Profile..." : "Creating Your Profile...");

            try {
                let imageUrl = userProfile ? userProfile.imageUrl : null;
                let username = userProfile ? userProfile.username : null;

                // Upload new image if provided
                if (imageFile) {
                    imageUrl = await uploadImage(imageFile);
                }

                // Generate username for new profiles
                if (!username) {
                    username = await generateUniqueUsername(name);
                }

                // Collect social media data
                const socialData = {};
                Object.keys(socialInputs).forEach(key => {
                    if (socialInputs[key] && socialInputs[key].value.trim()) {
                        socialData[key] = socialInputs[key].value.trim();
                    }
                });

                // Prepare profile data
                const profileData = {
                    name,
                    username,
                    location,
                    birthday,
                    imageUrl,
                    bio,
                    age,
                    ...socialData,
                    updatedAt: new Date().toISOString()
                };

                if (!userProfile) {
                    profileData.createdAt = new Date().toISOString();
                }

                // Save to Firestore
                await db.collection("profiles").doc(currentUser.uid).set(profileData, { merge: true });

                // Update local profile
                userProfile = profileData;

                // Hide loading and show success
                hideLoadingModal();
                showSuccessModal(username, userProfile ? "updated" : "created");

                // Update UI mode
                showExistingProfileMode();

            } catch (error) {
                hideLoadingModal();
                console.error("Error saving profile:", error);
                showToast("Something went wrong. Please try again.");
            }
        }

        // View Profile
        function viewProfile() {
            if (userProfile && userProfile.username) {
                window.open(`https://mywebsam.site/${userProfile.username}`, "_blank");
            }
        }

        // Show Delete Modal
        function showDeleteModal() {
            deleteModal.style.display = "block";
        }

        // Hide Delete Modal
        function hideDeleteModal() {
            deleteModal.style.display = "none";
        }

        // Delete Profile
        async function deleteProfile() {
            showLoadingModal("Deleting Your Profile...");
            
            try {
                await db.collection("profiles").doc(currentUser.uid).delete();
                
                userProfile = null;
                resetForm();
                showNewProfileMode();
                
                hideLoadingModal();
                hideDeleteModal();
                showToast("Profile deleted successfully");
                
            } catch (error) {
                hideLoadingModal();
                console.error("Error deleting profile:", error);
                showToast("Failed to delete profile. Please try again.");
            }
        }

        // Show Loading Modal
        function showLoadingModal(title = "Loading...") {
            loadingTitle.textContent = title;
            loadingModal.style.display = "block";
        }

        // Hide Loading Modal
        function hideLoadingModal() {
            loadingModal.style.display = "none";
        }

        // Show Success Modal
        function showSuccessModal(username, action = "created") {
            successTitle.textContent = `Profile ${action.charAt(0).toUpperCase() + action.slice(1)} Successfully!`;
            successMessage.textContent = `Your profile is now live and ready to share ðŸŽ‰`;
            profileUrl.textContent = `mywebsam.site/${username}`;
            successModal.style.display = "block";
        }

        // Hide Success Modal
        function hideSuccessModal() {
            successModal.style.display = "none";
        }

        // Copy Profile Link
        function copyProfileLink() {
            const profileUrlText = profileUrl.textContent;
            navigator.clipboard.writeText(profileUrlText)
                .then(() => {
                    showToast("Profile link copied to clipboard!");
                })
                .catch(err => {
                    console.error('Could not copy text: ', err);
                    showToast("Failed to copy link");
                });
        }

        // Open Profile
        function openProfile() {
            const profileUrlText = profileUrl.textContent;
            window.open(`https://${profileUrlText}`, "_blank");
        }

        // Show Toast Notification
        function showToast(message) {
            toastNotification.textContent = message;
            toastNotification.style.display = "block";
            toastNotification.style.position = "fixed";
            toastNotification.style.bottom = "20px";
            toastNotification.style.right = "20px";
            toastNotification.style.backgroundColor = "#333";
            toastNotification.style.color = "white";
            toastNotification.style.padding = "10px 20px";
            toastNotification.style.borderRadius = "5px";
            toastNotification.style.zIndex = "1000";

            setTimeout(() => {
                toastNotification.style.display = "none";
            }, 3000);
        }

        // Initialize App
        console.log("Profile Manager initialized");
    </script>
</body>
</html>